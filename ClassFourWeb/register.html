<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title></title>
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="hg-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <link rel="stylesheet" href="../../css/font-awesome.min.css">
    <link rel="stylesheet" href="../../lib/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="../../lib/admin/admin.css" media="all">
    <link rel="stylesheet" href="../../lib/Scrollbar/jquery.scrollbar.css">
    <script type="text/javascript" src="../../lib/admin/jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="../../lib/Scrollbar/jquery.scrollBar.js"></script>
    <script type="text/javascript" src="../../lib/layui/layui.js"></script>
    <script type="text/javascript" src="../../lib/admin/admin.js"></script>
    <script type="text/javascript" src="./js/jquery-1.12.4.min.js"></script>
    <style>

    </style>
</head>

<body class="layui-body-content">
    <div class="layui-fluid">
      <div class="layui-card">
        <div class="layui-card-header">
          <p style="text-align: center;font-size: large;">注册</p>
        </div>
        <div class="layui-card-body" style="padding: 15px;">
          <form class="layui-form" action="" lay-filter="component-form-group">
            <!-- 选择框 -->
            <div class="layui-form-item">
                <div class="layui-inline">
                  <label class="layui-form-label">角色选择</label>
                  <div class="layui-input-inline">
                    <select name="quiz" id="role_select">
                      <option value="">请选择</option>
                      <option value="3">个人用户</option>
                      <option value="1">调配站负责人</option>
                      <option value="2">接收站负责人</option>
                    </select>
                  </div>
                </div>
                <div class="layui-inline">     
                  <div class="layui-btn-container">
                    <!-- <button class="layui-btn layui-btn-xs">查看角色含义</button> -->
                    <dd lay-unselect>
                      <a onclick="window.open('user_guide.html')">
                          <div class="layui-btn-container">
                              <button class="layui-btn layui-btn-xs">查看角色含义</button>
                          </div>
                      </a>
                   <dd lay-unselect>
                  </div>
                </div>
              </div>
            <!-- 输入框 -->
            <div class="layui-form-item">
              <div class="layui-inline">
                <label class="layui-form-label">用户名</label>
                <div class="layui-input-inline">
                  <input type="text" id="username"class="layui-input">
                </div>
              </div>
              <div class="layui-inline">
                <label class="layui-form-label">密码</label>
                <div class="layui-input-inline">
                  <input type="password" id="password" class="layui-input">
                </div>
              </div>
              <div class="layui-inline">
                <label class="layui-form-label">确认密码</label>
                <div class="layui-input-inline">
                  <input type="password" id="password2" class="layui-input">
                </div>
              </div>
            </div>
            <div class="layui-form-item">
              <label class="layui-form-label">联系电话</label>
              <div class="layui-input-block">
                <input type="text" id="contact_phone" placeholder="" autocomplete="off" class="layui-input">
              </div>
          </div>

            <div class="layui-form-item">
                <label class="layui-form-label">个人地址</label>
                <div class="layui-input-block">
                  <input type="text" id="person_address" placeholder="" autocomplete="off" class="layui-input">
                </div>
            </div>

            <!-- 若非申请站点负责人, 则以下几项不是必填 -->
            <p style="text-align:center">若非申请站点负责人, 则以下几项不是必填</p>
            <hr class="layui-bg-green">
            <div class="layui-form-item">
              <label class="layui-form-label">验证身份证</label>
              <div class="layui-input-block">
                <input type="text" id="id_card" placeholder="" autocomplete="off" class="layui-input">
              </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">站点名称</label>
                <div class="layui-input-block">
                  <input type="text" id="station_name" placeholder="" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">选择站点地址</label>
                <div class="layui-input-block">
                  <div class="layui-inline">
                    <select name="quiz1" id="province_select" lay-filter="demo">
                        <option value='湖南省'>湖南省</option>
                        <option value='湖北省'>湖北省</option>
                        <option value='安徽省'>安徽省</option>
                        <option value='江西省'>江西省</option>
                        <option value='河南省'>河南省</option>
                    </select>
                  </div>
                  <div class="layui-inline">
                    <select name="quiz2" id="city_select">
                    </select>
                  </div>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">站点详细地址</label>
                <div class="layui-input-block">
                  <input type="text" id="station_address" placeholder="" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item layui-form-text">
                <label class="layui-form-label">上传资格凭证</label>
                <div class="layui-upload-drag" id="test-upload-drag">
                    <i class="layui-icon"></i>
                    <p>点击上传，或将文件拖拽到此处</p>
                  </div>
              </div>  
            <div class="layui-form-item layui-form-text">
              <label class="layui-form-label">备注</label>
              <div class="layui-input-block">
                <textarea id="station_remark" placeholder="请输入内容" class="layui-textarea"></textarea>
              </div>
            </div>        
            <div class="layui-form-item layui-layout-admin">
              <div class="layui-input-block">
                <div class="layui-footer" style="left: 0;padding: 10px 0;text-align: center;background-color: #fff;">
                  <button class="layui-btn" type="button" onclick="do_register()" >提交申请</button>
                  <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
</body>

<script>
    var image_url = "";

    /**
     * 暂未对输入的参数做校验
     */
    function do_register() {
        // 判断角色
        var select = document.getElementById("role_select");
        var idx = select.selectedIndex;
        var role = select.options[idx].value;
        
        if (role == "3") {
            alert(username + username.length);
            do_user_register();
        }
        else if (role == "1") do_station_register("http://120.53.24.57:8000/rds1123/register/design_manager");
        else if (role == "2") do_station_register("http://120.53.24.57:8000/rds1123/register/receive_manager");
        else alert("请先选择角色 ！");
    }

    function do_user_register() {
        
        $.ajax({
            type: "POST",
            url: "http://120.53.24.57:8000/rds1123/register/user",
            data: JSON.stringify({
                "username": document.getElementById("username").value,
                "password": document.getElementById("password").value,
                "password2": document.getElementById("password2").value,
                "phone": document.getElementById("contact_phone").value,
                "address": document.getElementById("person_address").value
            }),
            dataType: "json",
            contentType: "application/json;charset=utf-8",
            async: true, 
            timeout: 5000,
            success: function (result) {
                if (result.code != 200) {
                    alert(result.message);
                    return ;
                }
                window.location.href = "./login.html";
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                alert("注册失败 ！")
            },
            complete: function () {
        
            }
        });
    }

    function do_station_register(url) {
        var province_select = document.getElementById("province_select");
        var province_idx = province_select.selectedIndex;
        var station_province = province_select.options[province_idx].value;
        
        var city_select = document.getElementById("city_select");
        var city_idx = city_select.selectedIndex;
        var station_city = city_select.options[city_idx].value;

        if (image_url.length < 2){
            alert("请先上传资格凭证 ！");
            return;
        } 

        $.ajax({
            type: "POST",
            url: url,
            data: JSON.stringify({
                "username": document.getElementById("username").value,
                "password": document.getElementById("password").value,
                "password2": document.getElementById("password2").value,
                "phone": document.getElementById("contact_phone").value,
                "id_card": document.getElementById("id_card").value,
                "station_name": document.getElementById("station_name").value,
                "station_address": document.getElementById("station_address").value,
                "station_remark": document.getElementById("station_remark").value,
                "station_image": image_url,
                "station_province": station_province,
                "station_city": station_city,
                "station_county": "test-county"
            }),
            dataType: "json",
            contentType: "application/json;charset=utf-8",
            async: true, 

            timeout: 5000,
            success: function (result) {
                if (result.code != 0) {
                    alert(result.message);
                    return;
                }
                window.location.href = "./login.html";
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                alert("注册失败 ！")
            },
            complete: function () {
        
            }
        });
    }

    // 图片上传
    layui.use(['element', 'upload'], function () {
      var element = layui.element,
      upload = layui.upload;
      
      //拖拽上传
      upload.render({
        elem: '#test-upload-drag'
        ,url: 'http://120.53.24.57:8000/rds1123/register/image'
        ,done: function(res){
            image_url = res.data;
            alert(res.message);
        }
      });
      
  });

layui.use(['layer', 'jquery', 'form'], function () {
    var layer = layui.layer,
            $ = layui.jquery,
            form = layui.form;

    form.on('select(demo)', function(data){
        var sel = document.getElementById("province_select");
        var idx = sel.selectedIndex;
        var val = sel.options[idx].value; 
        var res = get_city_by_province(val);
        var city = document.getElementById("city_select");
        city.innerHTML = res;
        //最后再渲柒一次
        form.render('select');//select是固定写法 不是选择器
    });
});

function get_city_by_province(province) {
    var res = "";
    if (province == "湖南省") {
        res += "<option value='长沙市'>长沙市</option>";
        res += "<option value='岳阳市'>岳阳市</option>";
        res += "<option value='衡阳市'>衡阳市</option>";
    }
    else if (province == "湖北省") {
        res += "<option value='武汉市'>武汉市</option>";
        res += "<option value='荆州市'>荆州市</option>";
        res += "<option value='宜昌市'>宜昌市</option>";
    }
    else if (province == "安徽省") {
        res += "<option value='合肥市'>合肥市</option>";
        res += "<option value='阜阳市'>阜阳市</option>";
        res += "<option value='宿州市'>宿州市</option>";
    }
    else if (province == "江西省") {
        res += "<option value='南昌市'>南昌市</option>";
        res += "<option value='吉安市'>吉安市</option>";
    }
    else if (province == "河南省") {
        res += "<option value='南阳市'>南阳市</option>";
        res += "<option value='信阳市'>信阳市</option>";
        res += "<option value='郑州市'>郑州市</option>";
    }
    else {
        res += "";
    }
    return res;
}
</script>

</html>